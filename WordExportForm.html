<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <meta charset="UTF-8">
    <title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä Word-–∑–≤—ñ—Ç—É</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Toastify –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <!-- SortableJS –¥–ª—è Drag&Drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
    <style>
      * {box-sizing: border-box; transition: all 0.3s ease;}
      body {font-family: 'Roboto', sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 20px; color: #333;}
      h3 {margin-bottom: 20px; font-weight: 600; color: #2b3e50; text-align: center;}
      .container {max-width: 1100px; margin: auto; background: white; border-radius: 12px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);}
      .block {margin-bottom: 20px;}
      label {display: block; margin-bottom: 6px; font-weight: 500; color: #555;}
      input[type="text"],input[type="date"],textarea,select {width: 100%; padding: 10px 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 1em;}
      textarea {resize: vertical; min-height: 60px;}
      button {padding: 10px 16px; font-size: 1em; font-weight: 500; border: none; border-radius: 8px; cursor: pointer; transition: background-color 0.3s ease;}
      button:hover {opacity: 0.9;}
      .btn-main {background: #4a90e2; color: white;}
      .btn-add {background: #2ecc71; color: white;}
      .btn-remove {background: #e74c3c; color: white; font-size: 1em;}
      .btn-preview {background: #f39c12; color: white; font-size: 1em;}
      .btn-update-sheets {background: #27ae60; color: white; font-size: 1em;}
      .export-btn {margin-right: 10px;}
      .tableRow {display: flex; align-items: flex-start; gap: 10px; margin-top: 10px; flex-wrap: wrap; padding: 10px; border-left: 4px solid #4a90e2; background: #f9f9f9; border-radius: 6px; position: relative; cursor:move;}
      .sortable-ghost {opacity:0.6;}
      .previewArea {margin-top: 10px; overflow-x: auto; max-height: 200px; display: none; animation: fadeIn 0.3s;}
      @keyframes fadeIn {from {opacity: 0; transform: translateY(10px);} to {opacity: 1; transform: translateY(0);}}
      table.preview {border-collapse: collapse; width: 100%; font-size: 0.9em; border: 1px solid #ddd;}
      table.preview th, table.preview td {border: 1px solid #ddd; padding: 6px 10px; text-align: left;}
      table.preview th {background-color: #f2f2f2; font-weight: 600;}
      #status {margin-top: 20px; font-weight: bold; font-size: 1em; color: #2b3e50;}
      small {color: #888;}
      .progress-bar-background {
        width: 100%;
        background: #e0e0e0;
        border-radius: 8px;
        margin-top: 25px;
        height: 18px;
        position: relative;
        overflow: hidden;
        display: none;
      }
      .progress-bar {
        background: linear-gradient(90deg, #4a90e2, #2ecc71, #f39c12, #e74c3c, #4a90e2);
        background-size: 200% 100%;
        animation: progressmove 1s linear infinite;
        height: 100%;
        width: 100%;
        border-radius: 8px;
        transition: width 0.3s;
      }
      @keyframes progressmove {
        0% {background-position: 0% 50%;}
        100% {background-position: 100% 50%;}
      }
      .export-group {margin-bottom: 20px; text-align: center;}
    </style>
  </head>
  <body>
    <div class="container">
      <h3>üìä –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä Word-–∑–≤—ñ—Ç—É</h3>

      <form id="reportForm" autocomplete="off" onsubmit="exportReport();return false;">
      <div class="block">
        <label for="boss">–ù–∞—á–∞–ª—å–Ω–∏–∫:</label>
        <input id="boss" list="boss_list" type="text" placeholder="–Ü–≤–∞–Ω–æ–≤ –Ü.–Ü." required autocomplete="off">
        <datalist id="boss_list"></datalist>
      </div>

      <div class="block">
        <label for="date">–î–∞—Ç–∞:</label>
        <input id="date" type="date" required>
      </div>

      <div class="block">
        <label for="order">–ù–∞–∫–∞–∑:</label>
        <input id="order" type="text" placeholder="‚Ññ123 –≤—ñ–¥ 01.01.2025" required pattern="‚Ññ\d+ –≤—ñ–¥ \d{2}\.\d{2}\.\d{4}">
        <small>–§–æ—Ä–º–∞—Ç: ‚Ññ123 –≤—ñ–¥ 01.01.2025</small>
      </div>

      <div class="block">
        <label for="title">–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∑–≤—ñ—Ç—É:</label>
        <input id="title" type="text" placeholder="–ü—ñ–¥—Å—É–º–∫–æ–≤–∏–π –∑–≤—ñ—Ç –∑–∞ –∫–≤–∞—Ä—Ç–∞–ª" required>
      </div>

      <div class="block">
        <label for="description">–û–ø–∏—Å (–ø–æ—è—Å–Ω–µ–Ω–Ω—è):</label>
        <textarea id="description" placeholder="–î–æ–¥–∞–π—Ç–µ –ø–æ—è—Å–Ω—é–≤–∞–ª—å–Ω–∏–π —Ç–µ–∫—Å—Ç –¥–æ –∑–≤—ñ—Ç—É..." required></textarea>
      </div>

      <div class="block" id="tablesBlock">
        <label>–¢–∞–±–ª–∏—Ü—ñ (–ª–∏—Å—Ç + –¥—ñ–∞–ø–∞–∑–æ–Ω):</label>
        <div class="export-group">
          <button type="button" class="btn-update-sheets" onclick="updateSheetNames()">üîÑ –û–Ω–æ–≤–∏—Ç–∏ –ª–∏—Å—Ç–∏</button>
        </div>
        <div id="tablesList"></div>
        <button type="button" onclick="addTableRow()" class="btn-add">+ –î–æ–¥–∞—Ç–∏ —Ç–∞–±–ª–∏—Ü—é</button>
      </div>

      <div class="export-group">
        <button type="button" class="btn-main export-btn" onclick="exportReport('word')">üìÑ –°—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ Word</button>
        <button type="button" class="btn-main export-btn" onclick="exportReport('pdf')">üîΩ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ PDF</button>
        <button type="button" class="btn-main export-btn" onclick="exportReport('excel')">üìä –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ Excel</button>
      </div>
      <div class="progress-bar-background" id="progressBarBg">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      <div id="status"></div>
      </form>
    </div>

    <script>
      let sheetNames = [];

      // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–∑–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ñ–æ—Ä–º—ã –≤ localStorage
      const FORM_STORAGE_KEY = "word_export_form_state_v2";
      function saveFormState() {
        let state = {
          boss: document.getElementById('boss').value,
          date: document.getElementById('date').value,
          order: document.getElementById('order').value,
          title: document.getElementById('title').value,
          description: document.getElementById('description').value,
          tables: Array.from(document.querySelectorAll('.tableRow')).map(row => ({
            sheet: row.querySelector('.sheetSel').value,
            range: row.querySelector('.rangeInput').value
          }))
        };
        localStorage.setItem(FORM_STORAGE_KEY, JSON.stringify(state));
      }
      function loadFormState() {
        let s = localStorage.getItem(FORM_STORAGE_KEY);
        if (!s) return;
        try {
          let state = JSON.parse(s);
          document.getElementById('boss').value = state.boss || "";
          document.getElementById('date').value = state.date || "";
          document.getElementById('order').value = state.order || "";
          document.getElementById('title').value = state.title || "";
          document.getElementById('description').value = state.description || "";
          document.getElementById('tablesList').innerHTML = "";
          if (Array.isArray(state.tables) && state.tables.length) {
            state.tables.forEach(t => addTableRow(t.sheet, t.range));
          }
        } catch(e){}
      }
      function clearFormState() {
        localStorage.removeItem(FORM_STORAGE_KEY);
      }
      // Save on change
      setInterval(saveFormState, 700);

      // Drag & Drop reorder
      window.addEventListener('DOMContentLoaded', function() {
        new Sortable(document.getElementById('tablesList'), {
          animation: 150,
          handle: '.tableRow',
          ghostClass: 'sortable-ghost',
          onEnd: saveFormState
        });
      });

      function addTableRow(sheet='', range='') {
        const div = document.createElement('div');
        div.className = 'tableRow';
        div.innerHTML = `
          <span style="cursor:grab;user-select:none;" title="–ü–µ—Ä–µ—Ç—è–≥–Ω—ñ—Ç—å">&#x2630;</span>
          <select class="sheetSel">${sheetNames.map(n => `<option value="${n}" ${n===sheet?'selected':''}>${n}</option>`).join('')}</select>
          <input type="text" class="rangeInput" value="${range||'A1:B2'}" placeholder="A1:B2">
          <button type="button" class="btn-remove" title="–í–∏–¥–∞–ª–∏—Ç–∏">&#128465;</button>
          <button type="button" class="btn-preview" title="–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏">üëÅÔ∏è –ü–µ—Ä–µ–≥–ª—è–¥</button>
          <div class="previewArea"></div>
        `;
        document.getElementById('tablesList').appendChild(div);

        // Toggle preview on click
        div.querySelector('.btn-preview').addEventListener('click', () => {
          const previewArea = div.querySelector('.previewArea');
          if (previewArea.style.display === 'block') {
            previewArea.style.display = 'none';
          } else {
            showPreview(div.querySelector('.btn-preview'));
            previewArea.style.display = 'block';
          }
        });

        // Remove row on click
        div.querySelector('.btn-remove').addEventListener('click', () => {
          div.remove();
          saveFormState();
        });

        // Save state on change
        div.querySelector('.sheetSel').addEventListener('change', saveFormState);
        div.querySelector('.rangeInput').addEventListener('input', saveFormState);
      }

      function showPreview(btn) {
        const row = btn.parentElement;
        const sheet = row.querySelector('.sheetSel').value;
        const range = row.querySelector('.rangeInput').value;
        const previewArea = row.querySelector('.previewArea');
        previewArea.innerHTML = '‚è≥ –ó–∞–≤–∞–Ω—Ç–∞–∂—É—é...';

        google.script.run.withSuccessHandler(data => {
          if (!data.length) {
            previewArea.innerHTML = '<i>–î–∞–Ω—ñ –≤—ñ–¥—Å—É—Ç–Ω—ñ</i>';
            return;
          }
          let html = '<table class="preview"><tr>' +
            data[0].map(h => `<th>${h}</th>`).join('') + '</tr>';
          for (let i=1; i<data.length; ++i)
            html += '<tr>' + data[i].map(c => `<td>${c}</td>`).join('') + '</tr>';
          html += '</table>';
          previewArea.innerHTML = html;
        }).getPreviewData(sheet, range);
      }

      // –ú–∞—Å–∫–∞ –¥–ª—è –Ω–æ–º–µ—Ä–∞ –ø—Ä–∏–∫–∞–∑–∞
      document.addEventListener('DOMContentLoaded', function() {
        const orderInput = document.getElementById('order');
        orderInput.addEventListener('input', function() {
          this.setCustomValidity(this.value.match(/^‚Ññ\d+ –≤—ñ–¥ \d{2}\.\d{2}\.\d{4}$/) ? '' : '–§–æ—Ä–º–∞—Ç: ‚Ññ123 –≤—ñ–¥ 01.01.2025');
        });
      });

      // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–∏—Å—Ç–æ–≤
      function updateSheetNames() {
        google.script.run.withSuccessHandler(function(names){
          sheetNames = names;
          // –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏
          Array.from(document.querySelectorAll('.sheetSel')).forEach(sel => {
            let curr = sel.value;
            sel.innerHTML = sheetNames.map(n => `<option value="${n}">${n}</option>`).join('');
            sel.value = curr || sheetNames[0];
          });
          Toastify({text:"‚úÖ –õ–∏—Å—Ç–∏ –æ–Ω–æ–≤–ª–µ–Ω–æ!", backgroundColor: "#2ecc71"}).showToast();
        }).getSheetNames();
      }

      // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
      function showProgressBar(show=true) {
        const bg = document.getElementById('progressBarBg');
        bg.style.display = show ? 'block' : 'none';
      }

      // –≠–∫—Å–ø–æ—Ä—Ç Word/PDF/Excel
      function exportReport(format='word') {
        let form = document.getElementById('reportForm');
        if (!form.checkValidity()) {
          form.reportValidity();
          Toastify({text: "‚ùå –ó–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –æ–±–æ–≤ º—è–∑–∫–æ–≤—ñ –ø–æ–ª—è!", backgroundColor: "#e74c3c"}).showToast();
          return;
        }
        const header = {
          boss: document.getElementById('boss').value,
          date: document.getElementById('date').value,
          order: document.getElementById('order').value,
        };
        const title = document.getElementById('title').value;
        const description = document.getElementById('description').value;
        const tables = Array.from(document.querySelectorAll('.tableRow')).map(row => ({
          sheet: row.querySelector('.sheetSel').value,
          range: row.querySelector('.rangeInput').value,
        }));

        if (!tables.length) {
          Toastify({
            text: "‚ùå –î–æ–¥–∞–π—Ç–µ —Ö–æ—á–∞ –± –æ–¥–Ω—É —Ç–∞–±–ª–∏—Ü—é!",
            duration: 3000,
            gravity: "top",
            position: "center",
            backgroundColor: "#e74c3c"
          }).showToast();
          return;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ª–∏—Å—Ç–æ–≤ –∏ –¥–∏–∞–ø–∞–∑–æ–Ω–æ–≤
        for (const t of tables) {
          if (!t.sheet || !t.range) {
            Toastify({
              text: "‚ùå –ù–µ –æ–±—Ä–∞–Ω–æ –ª–∏—Å—Ç –∞–±–æ –¥—ñ–∞–ø–∞–∑–æ–Ω —É —Ç–∞–±–ª–∏—Ü—ñ!",
              duration: 4000,
              gravity: "top",
              position: "center",
              backgroundColor: "#e74c3c"
            }).showToast();
            return;
          }
        }

        document.getElementById('status').innerHTML = '';
        showProgressBar(true);

        let successHandler = function(url) {
          showProgressBar(false);
          let txt = '';
          if (format === 'word') txt = `<b>‚úÖ Word-—Ñ–∞–π–ª —Å—Ç–≤–æ—Ä–µ–Ω–æ!</b> <a href="${url}" target="_blank" style="color:#4a90e2;">üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</a>`;
          else if (format === 'pdf') txt = `<b>‚úÖ PDF-—Ñ–∞–π–ª —Å—Ç–≤–æ—Ä–µ–Ω–æ!</b> <a href="${url}" target="_blank" style="color:#4a90e2;">üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</a>`;
          else if (format === 'excel') txt = `<b>‚úÖ Excel-—Ñ–∞–π–ª —Å—Ç–≤–æ—Ä–µ–Ω–æ!</b> <a href="${url}" target="_blank" style="color:#4a90e2;">üì• –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏</a>`;
          document.getElementById('status').innerHTML = txt;
          Toastify({
            text: "‚úîÔ∏è –§–∞–π–ª —É—Å–ø—ñ—à–Ω–æ —Å—Ñ–æ—Ä–º–æ–≤–∞–Ω–æ!",
            duration: 3000,
            gravity: "top",
            position: "center",
            backgroundColor: "#2ecc71"
          }).showToast();
          clearFormState(); // –û—á–∏—Å—Ç–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –µ—Å–ª–∏ –≤—Å—ë —É—Å–ø–µ—à–Ω–æ
        };
        let failHandler = function(e) {
          showProgressBar(false);
          document.getElementById('status').innerHTML =
            `<span style="color:red;">‚ùå –ü–æ–º–∏–ª–∫–∞: ${e.message || e}</span>`;
          Toastify({
            text: `‚ùå –ü–æ–º–∏–ª–∫–∞: ${e.message || e}`,
            duration: 5000,
            gravity: "top",
            position: "center",
            backgroundColor: "#e74c3c"
          }).showToast();
        };

        if (format === 'word') {
          google.script.run.withSuccessHandler(successHandler).withFailureHandler(failHandler)
            .generateWordReport({ header, title, description, tables });
        } else if (format === 'pdf') {
          google.script.run.withSuccessHandler(successHandler).withFailureHandler(failHandler)
            .generatePdfReport({ header, title, description, tables });
        } else if (format === 'excel') {
          google.script.run.withSuccessHandler(successHandler).withFailureHandler(failHandler)
            .generateExcelReport({ header, title, description, tables });
        }
      }

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –ø–æ–ª—É—á–∏—Ç—å –ª–∏—Å—Ç—ã –∏ –¥–æ–±–∞–≤–∏—Ç—å –æ–¥–Ω—É —Ç–∞–±–ª–∏—Ü—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      google.script.run.withSuccessHandler(function(names){
        sheetNames = names;
        loadFormState();
        // –ï—Å–ª–∏ –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–µ—Ç —Ç–∞–±–ª–∏—Ü ‚Äî –¥–æ–±–∞–≤–∏—Ç—å –æ–¥–Ω—É –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        if (!document.querySelector('.tableRow') && sheetNames.length) addTableRow(sheetNames[0], 'A1:B2');
      }).getSheetNames();

      // –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–∞—á–∞–ª—å–Ω–∏–∫–∞ (datalist) –∏–∑ Google Sheets
      google.script.run.withSuccessHandler(function(arr){
        let dl = document.getElementById('boss_list');
        dl.innerHTML = "";
        arr.forEach(name => {
          let opt = document.createElement('option');
          opt.value = name;
          dl.appendChild(opt);
        });
      }).getBossesList();
    </script>
  </body>
</html>
